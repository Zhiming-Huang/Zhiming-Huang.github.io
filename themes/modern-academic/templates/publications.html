{% extends "base.html" %}

{% block title %}{{ page.title }} - {{ SITENAME }}{% endblock %}

{% block description %}{{ page.summary|striptags if page.summary else page.title }}{% endblock %}

{% block body_class %}page page-{{ page.slug }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="container-xl">
        <div class="row justify-content-center">
            <div class="col-lg-12 col-xl-10">
                <article class="py-5">
                    <header class="text-center mb-5 pb-4 border-bottom">
                        <h1 class="display-5 fw-bold mb-3" style="color: var(--custom-text-heading);">{{ page.title }}</h1>
                        <p class="lead text-muted">Complete list of academic publications</p>
                    </header>
                    
                    <!-- Filter Buttons with Integrated Search -->
                    <div class="text-center mb-5">
                        <div class="filter-search-container position-relative">
                            <!-- Filter Buttons -->
                            <div class="btn-group" role="group" aria-label="Publication filters" id="filter-buttons">
                                <button type="button" class="btn btn-outline-primary active" id="filter-all">All</button>
                                <button type="button" class="btn btn-outline-primary" id="filter-journal">Journal</button>
                                <button type="button" class="btn btn-outline-primary" id="filter-conference">Conference</button>
                                <button type="button" class="btn btn-outline-primary" id="filter-in-progress">In Progress</button>
                                <!-- Search Toggle Button -->
                                <button type="button" class="btn btn-outline-secondary" id="search-toggle" title="Search publications">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            
                            <!-- Expandable Search Box -->
                            <div class="search-overlay" id="search-overlay" style="display: none;">
                                <div class="search-container">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0">
                                            <i class="bi bi-search text-muted"></i>
                                        </span>
                                        <input type="text" class="form-control border-start-0 ps-0" id="search-input" 
                                               placeholder="Search publications by title, author, venue, or keywords..."
                                               aria-label="Search publications">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-search" title="Clear search">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" type="button" id="close-search" title="Close search">
                                            <i class="bi bi-chevron-up"></i>
                                        </button>
                                    </div>
                                    <div id="search-results-count" class="mt-2 text-muted small text-center" style="display: none;">
                                        <!-- Search results count will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Publications List -->
                    <div id="publications-container">
                        <!-- Publications will be populated by JavaScript -->
                    </div>
                    

                </article>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Publication data from publications.json (auto-synced by plugin)
        // Add cache busting to ensure fresh data
        const timestamp = new Date().getTime();
        const response = await fetch(`{{ SITEURL }}/theme/data/publications.json?v=${timestamp}`);
        const publications = await response.json();
        
        // Sort by date (newest first)
        publications.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Initial render
        renderPublications(publications);
        
        // Search functionality
        let currentFilter = 'all';
        let currentSearchTerm = '';
        let searchExpanded = false;
        
        const searchInput = document.getElementById('search-input');
        const clearButton = document.getElementById('clear-search');
        const closeButton = document.getElementById('close-search');
        const searchToggle = document.getElementById('search-toggle');
        const searchOverlay = document.getElementById('search-overlay');
        const filterButtons = document.getElementById('filter-buttons');
        const searchResultsCount = document.getElementById('search-results-count');
        
        // Toggle search overlay
        searchToggle.addEventListener('click', () => {
            toggleSearchOverlay();
        });
        
        // Close search overlay
        closeButton.addEventListener('click', () => {
            closeSearchOverlay();
        });
        
        // Search input event listener with debouncing
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearchTerm = this.value.trim();
                performSearchAndFilter(publications, currentFilter, currentSearchTerm);
            }, 300); // 300ms debounce
        });
        
        // Clear search button
        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            currentSearchTerm = '';
            searchResultsCount.style.display = 'none';
            performSearchAndFilter(publications, currentFilter, currentSearchTerm);
            searchInput.focus();
        });
        
        // Close search when clicking outside
        document.addEventListener('click', (e) => {
            if (searchExpanded && !searchOverlay.contains(e.target) && !searchToggle.contains(e.target)) {
                closeSearchOverlay();
            }
        });
        
        // Close search on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && searchExpanded) {
                closeSearchOverlay();
            }
        });
        
        // Filter event listeners
        document.getElementById('filter-all').addEventListener('click', () => {
            currentFilter = 'all';
            filterPublications(publications, 'all', currentSearchTerm);
        });
        document.getElementById('filter-journal').addEventListener('click', () => {
            currentFilter = 'journal';
            filterPublications(publications, 'journal', currentSearchTerm);
        });
        document.getElementById('filter-conference').addEventListener('click', () => {
            currentFilter = 'conference';
            filterPublications(publications, 'conference', currentSearchTerm);
        });
        document.getElementById('filter-in-progress').addEventListener('click', () => {
            currentFilter = 'in-progress';
            filterPublications(publications, 'in-progress', currentSearchTerm);
        });
        
        function toggleSearchOverlay() {
            const searchOverlay = document.getElementById('search-overlay');
            const searchInput = document.getElementById('search-input');
            
            if (!searchExpanded) {
                // Show search overlay
                searchOverlay.style.display = 'block';
                searchOverlay.classList.add('search-expanding');
                searchExpanded = true;
                
                // Focus on search input after animation
                setTimeout(() => {
                    searchInput.focus();
                    searchOverlay.classList.remove('search-expanding');
                }, 300);
            } else {
                closeSearchOverlay();
            }
        }

        function closeSearchOverlay() {
            const searchOverlay = document.getElementById('search-overlay');
            const searchInput = document.getElementById('search-input');
            const searchResultsCount = document.getElementById('search-results-count');
            
            if (searchExpanded) {
                searchOverlay.classList.add('search-collapsing');
                
                // Clear search if there's content
                if (currentSearchTerm) {
                    searchInput.value = '';
                    currentSearchTerm = '';
                    searchResultsCount.style.display = 'none';
                    performSearchAndFilter(publications, currentFilter, currentSearchTerm);
                }
                
                setTimeout(() => {
                    searchOverlay.style.display = 'none';
                    searchOverlay.classList.remove('search-collapsing');
                    searchExpanded = false;
                }, 300);
            }
        }
        
    } catch (error) {
        console.error('Error loading publications:', error);
        document.getElementById('publications-container').innerHTML = '<p class="text-center text-muted">Error loading publications data.</p>';
    }
});



function renderPublications(publications) {
    const container = document.getElementById('publications-container');
    container.innerHTML = '';
    
    publications.forEach((pub, index) => {
        const pubCard = createPublicationCard(pub, index);
        container.appendChild(pubCard);
    });
}

function createPublicationCard(pub, index) {
    const card = document.createElement('div');
    card.className = `publication-card card border-0 shadow-sm mb-4 ${pub.type} ${getStatusClass(pub.status)}`;
    
    // Status badge color
    const statusBadge = getStatusBadge(pub.status);
    
    // Award badge
    const awardBadge = pub.award ? `<span class="badge bg-warning text-dark ms-2"><i class="bi bi-trophy-fill me-1"></i>${pub.award}</span>` : '';
    
    card.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title fw-bold mb-0">${pub.title}</h5>
                <div class="flex-shrink-0">
                    ${statusBadge}
                    ${awardBadge}
                </div>
            </div>
            
            <p class="text-muted mb-2">
                <strong>Authors:</strong> ${processMarkdown(pub.authors)}
            </p>
            
            <p class="text-muted mb-2">
                <strong>Venue:</strong> ${pub.venue} 
                <span class="badge bg-light text-dark ms-2">${formatDate(pub.date)}</span>
            </p>
            
            ${pub.links && pub.links.length > 0 ? `
                <div class="mt-2">
                    <strong class="text-muted me-2">Links:</strong>
                    ${pub.links.map(link => `
                        <a href="${processFileUrl(link.url)}" class="btn ${getLinkButtonClass(link.type || link.text)} btn-sm me-2 mb-1" target="_blank" rel="noopener">
                            ${getLinkIcon(link.text)} ${link.text}
                        </a>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;
    
    return card;
}

function getStatusBadge(status) {
    const statusMap = {
        'Published': 'bg-success',
        'Accepted': 'bg-primary',
        'Under Review': 'bg-warning text-dark',
        'Major Revision': 'bg-info text-dark',
        'Minor Revision': 'bg-info text-dark', 
        'In Progress': 'bg-secondary'
    };
    
    const badgeClass = statusMap[status] || 'bg-secondary';
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

function getStatusClass(status) {
    if (status === 'In Progress' || status === 'Under Review' || status.includes('Revision')) {
        return 'in-progress';
    }
    return 'published';
}

function getLinkIcon(linkText) {
    const iconMap = {
        'PDF': '<i class="bi bi-file-pdf"></i>',
        'DOI': '<i class="bi bi-link-45deg"></i>',
        'IEEE': '<i class="bi bi-link-45deg"></i>',
        'ACM': '<i class="bi bi-link-45deg"></i>',
        'Springer': '<i class="bi bi-link-45deg"></i>',
        'arXiv': '<i class="bi bi-file-text"></i>',
        'Full PDF': '<i class="bi bi-file-pdf-fill"></i>',
        'Extended PDF': '<i class="bi bi-file-pdf-fill"></i>',
        'Technical Report': '<i class="bi bi-file-pdf-fill"></i>',
        'Code': '<i class="bi bi-github"></i>',
        'Github': '<i class="bi bi-github"></i>',
        'Slides': '<i class="bi bi-file-slides"></i>',
        'Video': '<i class="bi bi-camera-video"></i>',
        'Poster': '<i class="bi bi-image"></i>',
        'Demo': '<i class="bi bi-play-circle"></i>',
        'Dataset': '<i class="bi bi-database"></i>',
        'Draft': '<i class="bi bi-file-earmark-text"></i>'
    };
    
    return iconMap[linkText] || '<i class="bi bi-link"></i>';
}

function getLinkButtonClass(linkType) {
    // Publisher links (green)
    const publisherTypes = ['publisher', 'ieee', 'acm', 'springer', 'doi'];
    
    // Full version links (red) 
    const fullVersionTypes = ['full', 'full-pdf', 'extended', 'arxiv', 'technical-report'];
    
    if (publisherTypes.some(type => linkType.toLowerCase().includes(type))) {
        return 'btn-outline-success';
    }
    
    if (fullVersionTypes.some(type => linkType.toLowerCase().includes(type))) {
        return 'btn-outline-danger';
    }
    
    // Default (blue)
    return 'btn-outline-primary';
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const [year, month] = dateStr.split('-');
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return month ? `${monthNames[parseInt(month) - 1]} ${year}` : year;
}

function processFileUrl(url) {
    if (!url) return '';
    // If URL starts with http/https, return as is
    if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
    }
    // If URL already starts with /files/, return as is
    if (url.startsWith('/files/')) {
        return url;
    }
    // If it's just a filename, prepend /files/
    if (!url.includes('/')) {
        return `/files/${url}`;
    }
    // Otherwise return as is
    return url;
}

function processMarkdown(text) {
    if (!text) return '';
    // Convert **text** to <strong>text</strong>
    return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}

function filterPublications(publications, filter, searchTerm = '') {
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`filter-${filter}`).classList.add('active');
    
    performSearchAndFilter(publications, filter, searchTerm);
}

function performSearchAndFilter(publications, filter, searchTerm) {
    let filtered = publications;
    
    // Apply category filter first
    if (filter === 'journal') {
        filtered = publications.filter(pub => pub.type === 'journal');
    } else if (filter === 'conference') {
        filtered = publications.filter(pub => pub.type === 'conference');
    } else if (filter === 'in-progress') {
        filtered = publications.filter(pub => 
            pub.status === 'In Progress' || 
            pub.status === 'Under Review' || 
            pub.status.includes('Revision')
        );
    }
    
    // Apply search filter
    if (searchTerm && searchTerm.length > 0) {
        const searchTermLower = searchTerm.toLowerCase();
        filtered = filtered.filter(pub => {
            const titleMatch = pub.title && pub.title.toLowerCase().includes(searchTermLower);
            const authorsMatch = pub.authors && pub.authors.toLowerCase().includes(searchTermLower);
            const venueMatch = pub.venue && pub.venue.toLowerCase().includes(searchTermLower);
            const typeMatch = pub.type && pub.type.toLowerCase().includes(searchTermLower);
            const statusMatch = pub.status && pub.status.toLowerCase().includes(searchTermLower);
            
            return titleMatch || authorsMatch || venueMatch || typeMatch || statusMatch;
        });
    }
    
    // Update search results count
    updateSearchResultsCount(filtered.length, publications.length, searchTerm, filter);
    
    renderPublications(filtered);
}

function updateSearchResultsCount(filteredCount, totalCount, searchTerm, filter) {
    const searchResultsCount = document.getElementById('search-results-count');
    
    if (searchTerm && searchTerm.length > 0) {
        let message = `Found ${filteredCount} publication${filteredCount !== 1 ? 's' : ''}`;
        if (filter !== 'all') {
            const filterName = filter === 'in-progress' ? 'in progress' : filter;
            message += ` in ${filterName} category`;
        }
        message += ` matching "${searchTerm}"`;
        
        searchResultsCount.textContent = message;
        searchResultsCount.style.display = 'block';
        
        // Show "no results" message if needed
        if (filteredCount === 0) {
            searchResultsCount.innerHTML = `
                <span class="text-warning">No publications found matching "${searchTerm}"</span><br>
                <small>Try different keywords or clear the search to see all publications</small>
            `;
        }
    } else {
        searchResultsCount.style.display = 'none';
    }
}


</script>

<style>
/* Filter and Search Container */
.filter-search-container {
    display: inline-block;
    min-width: 400px;
}

/* Search Overlay */
.search-overlay {
    position: absolute;
    top: -1.5rem;
    left: 50%;
    transform: translateX(-50%);
    width: 500px;
    z-index: 1000;
    
    /* Glass morphism effect */
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 1rem;
    
    /* Enhanced shadow for glass effect */
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        0 4px 16px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.search-overlay.search-expanding {
    animation: expandSearch 0.3s ease;
}

.search-overlay.search-collapsing {
    animation: collapseSearch 0.3s ease;
}

@keyframes expandSearch {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-30px) scale(0.9);
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
}

@keyframes collapseSearch {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(-30px) scale(0.9);
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px);
    }
}

/* Fallback for browsers that don't support backdrop-filter */
@supports not (backdrop-filter: blur(10px)) {
    .search-overlay {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .search-container .input-group-text,
    .search-container .btn {
        background: rgba(248, 249, 250, 0.95);
    }
    
    .search-container .form-control {
        background: rgba(255, 255, 255, 0.95);
    }
    
    #search-results-count {
        background: rgba(248, 249, 250, 0.95);
    }
}

/* Search Input Group */
.search-container .input-group {
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.search-container .input-group-text {
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(248, 249, 250, 0.8);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
}

.search-container .form-control {
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    padding: 0.75rem;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.search-container .form-control:focus {
    border-color: var(--custom-text-heading);
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 
        0 0 0 0.2rem rgba(40, 102, 135, 0.25),
        0 4px 20px rgba(0, 0, 0, 0.15);
    outline: none;
}

.search-container .btn {
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(248, 249, 250, 0.8);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    transition: all 0.3s ease;
}

.search-container .btn:hover {
    background: rgba(233, 236, 239, 0.9);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* Search Toggle Button */
#search-toggle {
    transition: all 0.2s ease;
}

#search-toggle:hover {
    background-color: #e9ecef;
    transform: scale(1.05);
}

/* Search Results Count */
#search-results-count {
    animation: fadeIn 0.3s ease;
    background: rgba(248, 249, 250, 0.8);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    margin-top: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .search-overlay {
        width: 90vw;
        max-width: 400px;
    }
    
    .filter-search-container {
        min-width: auto;
    }
}

.publication-card {
    transition: all 0.3s ease;
}

.publication-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

.card-title {
    line-height: 1.4;
    color: var(--custom-text-heading);
}

.btn-group .btn {
    border-radius: 20px !important;
    margin: 0 2px;
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
}

.btn-group .btn.active {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.badge {
    font-size: 0.75rem;
}

.btn-outline-primary.btn-sm {
    font-size: 0.8rem;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
}
</style>
{% endblock %}
